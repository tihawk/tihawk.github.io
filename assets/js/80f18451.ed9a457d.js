"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8522],{2714:(e,n,t)=>{t.d(n,{A:()=>a});t(6540);const i={"donate-card":"donate-card_mbts",bmac:"bmac_qmhE"};var s=t(4848);function a(){return(0,s.jsx)("div",{className:"alert alert--primary",role:"alert",children:(0,s.jsxs)("div",{className:"card__body",children:[(0,s.jsx)("p",{children:"Thank you for reading!"}),(0,s.jsx)("p",{children:"The information in this blog, as well as all the tools, apps and libraries I develop are currently open source."}),(0,s.jsx)("p",{children:"I would love to keep it this way, and you can help!"}),(0,s.jsx)("p",{children:"You can buy me a coffee from here, which will go towards the next all-nighter I pull off!"}),(0,s.jsx)("a",{href:"https://www.buymeacoffee.com/kblagoev",target:"_blank",children:(0,s.jsx)("img",{src:"https://cdn.buymeacoffee.com/buttons/v2/default-violet.png",className:i.bmac,alt:"Buy Me A Coffee"})}),(0,s.jsxs)("p",{children:["Or you can support me and my code monthly over at ",(0,s.jsx)("a",{href:"https://github.com/sponsors/tihawk",target:"_blank",children:"Github Sponsors!"})]}),(0,s.jsx)("p",{children:"Thanks!"})]})})}},3474:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>c,toc:()=>h});var i=t(4848),s=t(8453),a=t(2714);const r={slug:"key-mission-cyberapocalypse-2021-ctf",title:"Key Mission - Cyberapocalypse 2021 CTF",description:"This is a writeup for the Key Mission challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Forensics.",authors:"kiroki",tags:["Cyber Security","CTF"]},o=void 0,c={permalink:"/blog/key-mission-cyberapocalypse-2021-ctf",source:"@site/blog/2021-04-30-08:55:28key-mission-cyberapocalypse-2021-ctf.md",title:"Key Mission - Cyberapocalypse 2021 CTF",description:"This is a writeup for the Key Mission challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Forensics.",date:"2021-04-30T00:00:00.000Z",formattedDate:"April 30, 2021",tags:[{label:"Cyber Security",permalink:"/blog/tags/cyber-security"},{label:"CTF",permalink:"/blog/tags/ctf"}],readingTime:4.635,hasTruncateMarker:!0,authors:[{name:"Kiril Panayotov Blagoev",title:"Admin",url:"https://github.com/tihawk",imageURL:"https://github.com/tihawk.png",key:"kiroki"}],frontMatter:{slug:"key-mission-cyberapocalypse-2021-ctf",title:"Key Mission - Cyberapocalypse 2021 CTF",description:"This is a writeup for the Key Mission challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Forensics.",authors:"kiroki",tags:["Cyber Security","CTF"]},unlisted:!1,prevItem:{title:"How to remember what I was reading about?",permalink:"/blog/how-to-remember-what-i-was-reading-about"},nextItem:{title:"Input as a Service - Cyberapocalypse 2021 CTF",permalink:"/blog/input-as-a-service-cyberapocalypse-2021-ctf"}},l={authorsImageUrls:[void 0]},h=[{value:"Prompt",id:"prompt",level:3},{value:"Recon",id:"recon",level:3},{value:"Analysis",id:"analysis",level:3},{value:"Solution",id:"solution",level:3}];function d(e){const n={a:"a",code:"code",em:"em",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"This is a writeup for the Key Mission challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Forensics."}),"\n",(0,i.jsx)(n.h3,{id:"prompt",children:"Prompt"}),"\n",(0,i.jsx)(n.p,{children:"The secretary of earth defense has been kidnapped. We have sent our elite team on the enemy's base to find his location. Our team only managed to intercept this traffic. Your mission is to retrieve secretary's hidden location."}),"\n",(0,i.jsx)(n.h3,{id:"recon",children:"Recon"}),"\n",(0,i.jsxs)(n.p,{children:["We're supplied with a Wireshark ",(0,i.jsx)(n.code,{children:".pcap"})," file, which seems to be filled with packets coming from an USB interface."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"No.\tTime\tSource\tDestination\tProtocol\tLength\tInfo\n1151\t244.436586\t3.2.1\thost\tUSB\t72\tURB_INTERRUPT in\n1152\t244.436609\thost\t3.2.1\tUSB\t64\tURB_INTERRUPT in\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We're particularly interested in the ones coming from Source ",(0,i.jsx)(n.code,{children:"3.2.1"}),", since they hold additional data in the form of 8 more bytes at the end of the packet data:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'0000   c0 46 bd 04 55 8c ff ff 43 01 81 02 03 00 2d 00   \xc0F\xbd.U.\xff\xffC.....-.\n0010   72 22 7f 60 00 00 00 00 d7 4c 0b 00 00 00 00 00   r".`....\xd7L......\n0020   08 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00   ................\n0030   01 00 00 00 00 00 00 00 04 02 00 00 00 00 00 00   ................\n0040   02 00 2d 00 00 00 00 00                           ..-.....\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In particular, we will be interested in the bytes which are 8th and 6th counting from the end, in this case ",(0,i.jsx)(n.code,{children:"02"})," and ",(0,i.jsx)(n.code,{children:"2d"})," respectively."]}),"\n",(0,i.jsx)(n.h3,{id:"analysis",children:"Analysis"}),"\n",(0,i.jsx)(n.p,{children:"From the name of the challenge, we can assume that we will be analysing a keyboard being used for typing. If we scroll around the packets in Wireshark, we will notice that the one byte which always changes is the 6th one from the end."}),"\n",(0,i.jsxs)(n.p,{children:["If we look up keyboard mappings, we will find ",(0,i.jsx)(n.a,{href:"https://www.usb.org/sites/default/files/documents/hut1_12v2.pdf",children:"this cool documentation"})," online for Usage tables of Human interface devices, which holds information on which byte codes mean what. For example, we can find that our ",(0,i.jsx)(n.code,{children:"2d"})," byte from above means the symbol ",(0,i.jsx)(n.code,{children:"-"})," (hyphen) or underscore ",(0,i.jsx)(n.code,{children:"_"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["This is where we come at a difficulty, because even though we have information that the shift key is supposedly sent as byte ",(0,i.jsx)(n.code,{children:"E1"}),", this is not how it's used in our pcap file."]}),"\n",(0,i.jsxs)(n.p,{children:["Initially I ignored this, and got a flag which didn't get accepted. It brought me to some frustration, but I kept digging until I found ",(0,i.jsx)(n.a,{href:"https://github.com/TeamRocketIst/ctf-usb-keyboard-parser",children:"this repo"})," on GitHub, in which the creator handled the ",(0,i.jsx)(n.em,{children:"shift"})," key in another way."]}),"\n",(0,i.jsxs)(n.p,{children:["Namely, he took the ",(0,i.jsx)(n.code,{children:"0x40"}),"-th byte (or 8th counting from the end) from the packet data, and if it was a ",(0,i.jsx)(n.code,{children:"02"})," or a ",(0,i.jsx)(n.code,{children:"20"}),", that would mean that the (left or right) shift key is pressed."]}),"\n",(0,i.jsx)(n.p,{children:"At this point, we can just use that script, and get our flag, but I wanted to do it with my own script, which was 95% working at this point."}),"\n",(0,i.jsx)(n.h3,{id:"solution",children:"Solution"}),"\n",(0,i.jsx)(n.p,{children:"Applying everything we learned, we can go ahead and"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Take the mappings from the pdf documentation, and create a dictionary of hex -> key value pairs."}),"\n",(0,i.jsxs)(n.li,{children:["Write a script which loads the ",(0,i.jsx)(n.code,{children:"pcap"})," file, using ",(0,i.jsx)(n.code,{children:"scapy"})," for example."]}),"\n",(0,i.jsx)(n.li,{children:"Read the 6th and 8th bytes counting from the end of each packet data."}),"\n",(0,i.jsxs)(n.li,{children:["Use the 8th byte to detect ",(0,i.jsx)(n.code,{children:"Shift"})," presses."]}),"\n",(0,i.jsx)(n.li,{children:"Use the 6th byte to determine the symbol being typed."}),"\n",(0,i.jsx)(n.li,{children:"String it all together (we can also handle backspace by removing the last element from our string)."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'#!/usr/bin/env python3\n\nfrom scapy.all import *\nimport sys\n\nmapping_shift = {\n  0x02: \'<Shift>\',\n  0x20: \'<RShift>\'\n}\n\nmapping = {\n  0x00: ["", ""],\n  0x01: ["ErrorRollOver", "ErrorRollOver"],\n  0x02: ["POSTFail9", "POSTFail9"],\n  0x03: ["ErrorUndefined", "ErrorUndefined"],\n  0x04: ["a", "A"],\n  0x05: ["b", "B"],\n  0x06: ["c", "C"],\n  0x07: ["d", "D"],\n  0x08: ["e", "E"],\n  0x09: ["f", "F"],\n  0x0A: ["g", "G"],\n  0x0B: ["h", "H"],\n  0x0C: ["i", "I"],\n  0x0D: ["j", "J"],\n  0x0E: ["k", "K"],\n  0x0F: ["l", "L"],\n  0x10: ["m", "M"],\n  0x11: ["n", "N"],\n  0x12: ["o", "O"],\n  0x13: ["p", "P"],\n  0x14: ["q", "Q"],\n  0x15: ["r", "R"],\n  0x16: ["s", "S"],\n  0x17: ["t", "T"],\n  0x18: ["u", "U"],\n  0x19: ["v", "V"],\n  0x1A: ["w", "W"],\n  0x1B: ["x", "X"],\n  0x1C: ["y", "Y"],\n  0x1D: ["z", "Z"],\n  0x1E: ["1", "!"],\n  0x1F: ["2", "@"],\n  0x20: ["3", "#"],\n  0x21: ["4", "$"],\n  0x22: ["5", "%"],\n  0x23: ["6", "^"],\n  0x24: ["7", "&"],\n  0x25: ["8", "*"],\n  0x26: ["9", "("],\n  0x27: ["0", ")"],\n  0x28: ["Return", "Return"],\n  0x29: ["ESCAPE", "ESCAPE"],\n  0x2A: ["<BACKSPACE>", "<BACKSPACE>"],\n  0x2B: ["Tab", "Tab"],\n  0x2C: [" ", " "],\n  # 0x2C: "Spacebar",\n  0x2D: ["-", "_"],\n  0x2E: ["=", "+"],\n  0x2F: ["[", "{"],\n  0x30: ["]", "}"],\n  0x31: ["\\\\", "|"],\n  0x32: ["Non-US"],\n  0x33: [";", ":"],\n  0x34: ["\u2018", "\\""],\n  0x35: ["Grave"],\n  0x36: [",", "<"],\n  0x37: [".", ">"],\n  0x38: ["/", "?"]\n  # [OMITTED REST OF CODES FOR BREVITY]\n}\n\ntry:\n  packets = rdpcap(sys.argv[1])\n  print(packets)\nexcept:\n  print(\'needs a pcap file supplied\')\n  exit(-1)\n\nresult = \'\'\nfor packet in packets:\n  shift_byte = packet[0].load[-8]\n  shift_key = 0\n\n  if shift_byte in mapping_shift:\n    shift_key = 1\n\n  normal_byte = packet[0].load[-6]\n  stringed = mapping[normal_byte][shift_key]\n\n  if stringed == mapping[0x2A][0]:\n    # if backspace, remove one\n    result = result[:-1]\n  else:\n    result += stringed\n\nprint(result)\n'})}),"\n",(0,i.jsx)(n.p,{children:"And, with this we can get the message being sent by our secret agent:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"python3 get_flag.py key_mission.pcap \nWARNING: PcapReader: unknown LL type [220]/[0xdc]. Using Raw packets\n<key_mission.pcap: TCP:0 UDP:0 ICMP:0 Other:1192>\nI am sending secretary\u2018s location over this totally encrypted channel to make sure no one else will be able to read it except of us. This information is confidential and must not be shared with anyone else. The secretary\u2018s hidden location is CHTB{a_plac3_fAr_fAr_away_fr0m_earth}\n"})}),"\n",(0,i.jsx)(n.p,{children:"With the flag now in plain sight"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"CHTB{a_plac3_fAr_fAr_away_fr0m_earth}\n"})}),"\n","\n","\n",(0,i.jsx)(a.A,{})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var i=t(6540);const s={},a=i.createContext(s);function r(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);